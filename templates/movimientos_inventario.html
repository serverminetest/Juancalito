{% extends "base.html" %}

{% block title %}Historial de Movimientos{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-history"></i> Historial de Movimientos</h2>
        <div class="btn-group" role="group">
            <a href="{{ url_for('inventarios') }}" class="btn btn-outline-primary">
                <i class="fas fa-home"></i> Inventarios
            </a>
            <a href="{{ url_for('productos_inventario') }}" class="btn btn-outline-info">
                <i class="fas fa-list"></i> Ver Productos
            </a>
            <a href="{{ url_for('nuevo_movimiento_inventario') }}" class="btn btn-success">
                <i class="fas fa-plus"></i> Nuevo Movimiento
            </a>
        </div>
    </div>

    <!-- Búsqueda Rápida -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="GET" id="form-busqueda">
                <div class="input-group input-group-lg">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" name="busqueda" id="busqueda" class="form-control" 
                           placeholder="Buscar por producto, responsable, motivo, referencia..." 
                           value="{{ busqueda_actual }}" autocomplete="off">
                    <button class="btn btn-outline-secondary" type="button" onclick="limpiarBusqueda()">
                        <i class="fas fa-times"></i>
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosAvanzados">
                        <i class="fas fa-filter"></i> Filtros
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtros Avanzados (Colapsable) -->
    <div class="collapse" id="filtrosAvanzados">
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-sliders-h"></i> Filtros Avanzados</h6>
            </div>
            <div class="card-body">
                <form method="GET" id="form-filtros" class="row g-3">
                    <!-- Buscar (hidden) -->
                    <input type="hidden" name="busqueda" value="{{ busqueda_actual }}">
                    
                    <!-- Producto específico -->
                    <div class="col-md-3">
                        <label for="producto_id" class="form-label"><i class="fas fa-box"></i> Producto</label>
                        <select name="producto_id" id="producto_id" class="form-select">
                            <option value="">Todos los productos</option>
                            {% for producto in productos %}
                            <option value="{{ producto.id }}" {% if producto_actual == producto.id %}selected{% endif %}>
                                {{ producto.codigo }} - {{ producto.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Tipo de movimiento -->
                    <div class="col-md-2">
                        <label for="tipo_movimiento" class="form-label"><i class="fas fa-exchange-alt"></i> Tipo</label>
                        <select name="tipo_movimiento" id="tipo_movimiento" class="form-select">
                            <option value="">Todos</option>
                            <option value="ENTRADA" {% if tipo_actual == 'ENTRADA' %}selected{% endif %}>
                                <i class="fas fa-arrow-down"></i> Entrada
                            </option>
                            <option value="SALIDA" {% if tipo_actual == 'SALIDA' %}selected{% endif %}>
                                <i class="fas fa-arrow-up"></i> Salida
                            </option>
                        </select>
                    </div>

                    <!-- Categoría -->
                    <div class="col-md-2">
                        <label for="categoria" class="form-label"><i class="fas fa-tags"></i> Categoría</label>
                        <select name="categoria" id="categoria" class="form-select">
                            <option value="">Todas</option>
                            {% for cat in categorias %}
                            <option value="{{ cat }}" {% if categoria_actual == cat %}selected{% endif %}>{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Período -->
                    <div class="col-md-2">
                        <label for="periodo" class="form-label"><i class="fas fa-calendar"></i> Período</label>
                        <select name="periodo" id="periodo" class="form-select">
                            <option value="">Todos</option>
                            {% for p in periodos_disponibles %}
                            <option value="{{ p }}" {% if periodo_actual == p %}selected{% endif %}>{{ p }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Responsable -->
                    <div class="col-md-3">
                        <label for="responsable" class="form-label"><i class="fas fa-user"></i> Responsable</label>
                        <select name="responsable" id="responsable" class="form-select">
                            <option value="">Todos</option>
                            {% for resp in responsables %}
                            <option value="{{ resp }}" {% if responsable_actual == resp %}selected{% endif %}>{{ resp }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Fecha desde -->
                    <div class="col-md-2">
                        <label for="fecha_desde" class="form-label"><i class="fas fa-calendar-alt"></i> Desde</label>
                        <input type="date" name="fecha_desde" id="fecha_desde" class="form-control" value="{{ fecha_desde_actual }}">
                    </div>

                    <!-- Fecha hasta -->
                    <div class="col-md-2">
                        <label for="fecha_hasta" class="form-label"><i class="fas fa-calendar-check"></i> Hasta</label>
                        <input type="date" name="fecha_hasta" id="fecha_hasta" class="form-control" value="{{ fecha_hasta_actual }}">
                    </div>

                    <!-- Ordenar por -->
                    <div class="col-md-3">
                        <label for="orden" class="form-label"><i class="fas fa-sort"></i> Ordenar por</label>
                        <select name="orden" id="orden" class="form-select">
                            <option value="fecha_desc" {% if orden_actual == 'fecha_desc' %}selected{% endif %}>Fecha (más reciente)</option>
                            <option value="fecha_asc" {% if orden_actual == 'fecha_asc' %}selected{% endif %}>Fecha (más antiguo)</option>
                            <option value="cantidad_desc" {% if orden_actual == 'cantidad_desc' %}selected{% endif %}>Cantidad (mayor)</option>
                            <option value="cantidad_asc" {% if orden_actual == 'cantidad_asc' %}selected{% endif %}>Cantidad (menor)</option>
                            <option value="producto" {% if orden_actual == 'producto' %}selected{% endif %}>Por producto</option>
                        </select>
                    </div>

                    <!-- Botones -->
                    <div class="col-md-5 d-flex gap-2 align-items-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Aplicar Filtros
                        </button>
                        <a href="{{ url_for('movimientos_inventario') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-redo"></i> Limpiar Todo
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Estadísticas Rápidas -->
    {% if movimientos %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4>{{ movimientos|length }}</h4>
                    <small>Total Movimientos</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4>{{ total_entradas }}</h4>
                    <small>Total Entradas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <h4>{{ total_salidas }}</h4>
                    <small>Total Salidas</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tabla de Movimientos -->
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-list"></i> Movimientos de Inventario</h5>
        </div>
        <div class="card-body">
            {% if movimientos %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>Producto</th>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Total</th>
                            <th>Motivo</th>
                            <th>Referencia</th>
                            <th>Responsable</th>
                            <th>Proveedor</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for movimiento in movimientos %}
                        <tr>
                            <td>
                                <small>{{ (movimiento.fecha_movimiento | colombia_time).strftime('%d/%m/%Y') }}</small><br>
                                <small class="text-muted">{{ (movimiento.fecha_movimiento | colombia_time).strftime('%H:%M') }}</small>
                            </td>
                            <td>
                                <strong>{{ movimiento.producto.codigo }}</strong><br>
                                <small>{{ movimiento.producto.nombre }}</small>
                            </td>
                            <td>
                                {% if movimiento.tipo_movimiento == 'ENTRADA' %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-arrow-down"></i> Entrada
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-arrow-up"></i> Salida
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ movimiento.cantidad }}</strong><br>
                                <small class="text-muted">
                                    {% if movimiento.producto.unidad_medida.upper() in ['L', 'LITRO', 'LITROS'] %}
                                        L
                                    {% elif movimiento.producto.unidad_medida.upper() in ['KG', 'KILO', 'KILOS', 'KILOGRAMO', 'KILOGRAMOS'] %}
                                        KG
                                    {% elif movimiento.producto.unidad_medida.upper() in ['G', 'GRAMO', 'GRAMOS'] %}
                                        G
                                    {% elif movimiento.producto.unidad_medida.upper() in ['ML', 'MILILITRO', 'MILILITROS'] %}
                                        ML
                                    {% elif movimiento.producto.unidad_medida.upper() in ['CC', 'CENTIMETRO CUBICO', 'CENTIMETROS CUBICOS'] %}
                                        CC
                                    {% else %}
                                        {{ movimiento.producto.unidad_medida }}
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                {% if movimiento.debe_tener_precio() %}
                                ${{ "{:,.0f}".format(movimiento.precio_unitario) }}
                                {% else %}
                                <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if movimiento.debe_tener_precio() %}
                                <strong>${{ "{:,.0f}".format(movimiento.total) }}</strong>
                                {% else %}
                                <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if movimiento.motivo %}
                                    <small>{{ movimiento.motivo }}</small>
                                {% else %}
                                    <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if movimiento.referencia %}
                                    <small>{{ movimiento.referencia }}</small>
                                {% else %}
                                    <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if movimiento.responsable %}
                                    <small>{{ movimiento.responsable }}</small>
                                {% else %}
                                    <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if movimiento.producto.proveedor %}
                                    <small>{{ movimiento.producto.proveedor }}</small>
                                {% else %}
                                    <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="eliminarMovimiento({{ movimiento.id }}, '{{ movimiento.producto.nombre }}', {{ movimiento.cantidad }}, '{{ movimiento.tipo_movimiento }}')"
                                        title="Eliminar movimiento">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Resumen -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="text-info mb-3"><i class="fas fa-chart-bar"></i> Resumen de Movimientos</h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Total Movimientos:</strong> {{ movimientos|length }}
                                </div>
                                <div class="col-md-3">
                                    <strong>Entradas:</strong> 
                                    <span class="badge bg-success">
                                        {{ movimientos|selectattr('tipo_movimiento', 'equalto', 'ENTRADA')|list|length }}
                                    </span>
                                </div>
                                <div class="col-md-3">
                                    <strong>Salidas:</strong> 
                                    <span class="badge bg-danger">
                                        {{ movimientos|selectattr('tipo_movimiento', 'equalto', 'SALIDA')|list|length }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-history fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No se encontraron movimientos</h5>
                <p class="text-muted">
                    {% if producto_actual or tipo_actual or fecha_desde_actual or fecha_hasta_actual %}
                        No hay movimientos que coincidan con los filtros aplicados.
                    {% else %}
                        Aún no hay movimientos registrados en el inventario.
                    {% endif %}
                </p>
                <a href="{{ url_for('nuevo_movimiento_inventario') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Registrar Primer Movimiento
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function limpiarBusqueda() {
    document.getElementById('busqueda').value = '';
    document.getElementById('form-busqueda').submit();
}

// Función para eliminar movimiento
function eliminarMovimiento(movimientoId, productoNombre, cantidad, tipoMovimiento) {
    const tipoTexto = tipoMovimiento === 'ENTRADA' ? 'entrada' : 'salida';
    const accionTexto = tipoMovimiento === 'ENTRADA' ? 'restar' : 'sumar';
    
    if (confirm(`¿Estás seguro de eliminar esta ${tipoTexto}?\n\n` +
                `Producto: ${productoNombre}\n` +
                `Cantidad: ${cantidad}\n` +
                `Tipo: ${tipoMovimiento}\n\n` +
                `Esto ${accionTexto}á ${cantidad} unidades al stock actual.`)) {
        
        // Mostrar loading
        const btn = event.target.closest('button');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        // Enviar petición de eliminación
        fetch(`/inventarios/movimientos/eliminar/${movimientoId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de éxito
                alert(`✅ Movimiento eliminado exitosamente.\n\nStock corregido: ${data.stock_anterior} → ${data.stock_actual}`);
                // Recargar la página para mostrar los cambios
                window.location.reload();
            } else {
                alert(`❌ Error al eliminar movimiento: ${data.message}`);
                // Restaurar botón
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Error de conexión al eliminar movimiento');
            // Restaurar botón
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        });
    }
}

// Atajos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl+F para enfocar búsqueda
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('busqueda').focus();
    }
});
</script>
{% endblock %}
